# SM100 资源占用分析（优化版）

基于 `test_operator/mla_bwd/mla_bwd.cuh` 的代码分析以及 `SM100.md` 的硬件规格，以下是关于 SM100 架构上 MLA Backward 阶段 (head dim 128) 的 Shared Memory 和 TMEM 资源占用分析（优化后版本）。

假设配置：`D_QK = 576`（`D_V=512`, `D_ROPE=64`），`B_H=128`，`B_TOPK=32`，2CTA 协作。

## 1. TMEM (Tensor Memory) 占用分析

SM100 的 TMEM 总容量为 256 KB，结构为 128 行 x 512 列 x 4 字节。该反向 kernel 通过 `tmem_cols` 做静态列划分，并显式复用了部分列区间。

### 列分配情况
代码定义如下（`mla_bwd.cuh`）：
```cpp
struct tmem_cols {
    static constexpr int dQ = 0;
    static constexpr int dQ_RoPE = 256;
    static constexpr int dKV = 288;
    static constexpr int dKV_RoPE = 352;
    static constexpr int dP = 352;   // 与 dKV_RoPE 复用
    static constexpr int P = 368;
    static constexpr int dO = 384;
};
```

| 变量 | 描述 | 数据类型 | Shape | 起始列 | 结束列 | 占用列数 | 占用大小 (KB) | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| `dQ` | dQ NoPE 累加器 | fp32 | [64, 512] | 0 | 256 | **256** | 128 | dQ 主体 |
| `dQ_RoPE` | dQ RoPE 累加器 | fp32 | [64, 64] | 256 | 288 | **32** | 16 | dQ rope |
| `dKV` | dKV NoPE 分块累加器 | fp32 | [32, 256] | 288 | 352 | **64** | 32 | part0/part1 时间复用 |
| `dKV_RoPE` | dKV RoPE 累加器 | fp32 | [32, 64] | 352 | 368 | **16** | 8 | 与 `dP` 复用 |
| `dP` | dP 缓冲 | fp32 | [64, 32] | 352 | 368 | **16** | 8 | 与 `dKV_RoPE` 复用 |
| `P` | softmax(P) / logits 缓冲 | fp32 | [64, 32] | 368 | 384 | **16** | 8 | WG0/WG3 协同 |
| `dO` | dO 中间缓冲 | bf16 | [64, 512] | 384 | 512 | **128** | 64 | 采用 bf16 存储 |
| **总计** |  |  |  |  |  | **512** | **256** | 含复用，覆盖全列空间 |

### 结论
- **TMEM 使用量**: 256 KB (512 列)
- **TMEM 总容量**: 256 KB (512 列)
- **使用率**: **100%**

优化后依然是 TMEM 满占用设计，但通过 `dKV_RoPE <-> dP` 列复用把中间态压缩在固定 512 列内。

---

## 2. Shared Memory (共享内存) 占用分析

SM100 每 SM 可配置的最大共享内存为 227 KB。该反向 kernel 使用 `SharedMemoryPlan` 管理共享内存，核心优化点是 `union` 时间复用与更小 `B_TOPK=32` tile。

### 内存布局计算
`SharedMemoryPlan` 包含一个联合体 `u`（运行阶段复用）和固定成员区。

#### A. Union 部分 (取最大值)

1. `u.q_kv`（Q+KV 计算阶段）
- `kv`: `[16, 576]` bf16 = `16*576*2` = **18,432 B**
- `kv_peer`: `[16, 576]` bf16 = `16*576*2` = **18,432 B**
- `q_nope`: `[64, 512]` bf16 = `64*512*2` = **65,536 B**
- `q_rope`: `[64, 64]` bf16 = `64*64*2` = **8,192 B**
- 小计：**110,592 B**（108.0 KB）

2. `u.dq`（dQ 输出阶段）
- `dq`: `[64, 576]` bf16 = `64*576*2` = **73,728 B**（72.0 KB）

**Union 最大占用**: **110,592 B**（108.0 KB）

#### B. 固定成员部分

1. `sdKV`: `[32, 576]` fp32 = `32*576*4` = **73,728 B**（72.0 KB）
2. `s_ds`:
- `s`: `[64,32]` bf16 = `64*32*2` = **4,096 B**
- `ds`: `[64,32]` bf16 = `64*32*2` = **4,096 B**
- 合计 = **8,192 B**（8.0 KB）
3. `is_k_valid[B_TOPK/8]` = `32/8` = **4 B**
4. barriers: 共 19 个 `transac_bar_t`（按 8B/个估算）= **152 B**
5. `tmem_start_addr` = **4 B**
6. rowwise buffers:
- `rowwise_max_buf[128]` = 512 B
- `rowwise_li_buf[128]` = 512 B
- `rowwise_delta_buf[128]` = 512 B
- 合计 = **1,536 B**

**固定成员总计**: **83,616 B**（约 81.7 KB）

### 总占用量与使用率

| 组件 | 大小 (Bytes) | 大小 (KB) |
| :--- | :--- | :--- |
| Union (Max) | 110,592 | 108.0 |
| 固定成员 | 83,616 | 81.7 |
| **总计** | **194,208** | **189.7** |

- **SM100 共享内存上限**: 227 KB (232,448 Bytes)
- **预估使用量**: ~189.7 KB
- **使用率**: **~83.6%**

### 结论
优化后共享内存压力明显下降，已从“接近硬上限”回落到较安全区间。主要来源是：
- `B_TOPK` 从 64 降到 32，直接减半了 S/dS 与 KV 相关工作集。
- `u.q_kv` 与 `u.dq` 强复用，避免 dQ 和 Q/KV 同时驻留。

---

## 3. 与优化前对比（按文档口径）

| 指标 | 优化前（`SM100Head128反向资源占用分析.md`） | 优化后（当前） | 变化 |
| :--- | :--- | :--- | :--- |
| `B_TOPK` | 64 | 32 | -50% |
| TMEM 使用率 | 100% | 100% | 持平 |
| SMEM 使用量 | ~225.7 KB | ~189.7 KB | **-36.0 KB** |
| SMEM 使用率 | ~99.4% | ~83.6% | **-15.8 pct** |

### 总体结论
1. **TMEM 仍是硬约束**：优化后仍然 512 列满配（100%）。
2. **SMEM 从极限态回落**：约 189.7 KB / 227 KB，显著降低了溢出和调参风险。
3. **工程意义**：后续可在不突破 SMEM 上限的前提下，留出一定空间给额外 staging/buffer；但若增加 TMEM 中间态，仍需优先依赖时间复用而非空间扩张。

> 注：以上为基于 `mla_bwd.cuh` 的静态布局估算；`transac_bar_t` 的精确大小及最终 `sizeof(SharedMemoryPlan)` 仍以编译产物为准。
