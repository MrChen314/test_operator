# SM100 Head128 反向资源占用分析（优化版）

基于 `mla_bwd/mla_bwd.cuh` 的**当前静态定义**，对比 `0资源占用分析/SM100Head128反向资源占用分析.md` 的旧口径，重新评估 TMEM / SMEM 占用与优化空间。

> 口径说明：本文件以 `mla_bwd.cuh` 为准（`B_TOPK=32`，`tmem_cols` 新布局，`SharedMemoryPlan` 含 `sdKV`）。

## 1. 关键配置变化（相对旧分析）

- `B_TOPK`: `64 -> 32`（`mla_bwd/mla_bwd.cuh:56`）
- TMEM 列映射重排（新增 `S/dS/kv_peer` 段，`dP` 位置前移）
- SMEM 结构变化：保留 `u.q_kv <-> u.dq` union 复用
- SMEM 结构变化：新增常驻 `sdKV`（float，注释形状 `[B_TOPK, D_K] = [32, 576]`）
- `s/ds` 从旧文档中的 SMEM 常驻区移除（按当前 `.cuh` 结构）

## 2. TMEM 占用重算

### 2.1 按列地址区间的静态映射

`mla_bwd/mla_bwd.cuh`：

```cpp
struct tmem_cols {
    dQ = 0;
    dQ_RoPE = 256;
    dKV = 288;
    dKV_RoPE = 416;
    dP = 432;
    S = 448;
    dS = 456;
    P = 464;
    kv_peer = 464;
};
```

按起始列差值统计：

| 段 | 起始列 | 下一段起始列 | 占用列数 | 估算大小 |
| :--- | :---: | :---: | :---: | :---: |
| `dQ` | 0 | 256 | 256 | 128 KB |
| `dQ_RoPE` | 256 | 288 | 32 | 16 KB |
| `dKV` | 288 | 416 | 128 | 64 KB |
| `dKV_RoPE` | 416 | 432 | 16 | 8 KB |
| `dP` | 432 | 448 | 16 | 8 KB |
| `S` | 448 | 456 | 8 | 4 KB |
| `dS` | 456 | 464 | 8 | 4 KB |
| `P/kv_peer` 复用段 | 464 | 500* | 36（按注释） | 18 KB |

`*` 说明：`kv_peer` 注释给出 36 列需求（`[B_TOPK/2, D_K]=[16,576] bf16`）。若仅按 `P` 视角则是 16 列。

### 2.2 结论（TMEM）

- 逻辑映射下，最高使用列到 `500` 左右，留白约 `12` 列（约 6 KB）。
- 但实现里 TMEM 分配仍是 `allocate(512)`（见 `mla_bwd.cu`），运行时仍按**整块 512 列**占用。
- 因此，地址布局层面比旧版更有“列复用弹性”。
- 因此，资源分配层面仍是 256KB 满占用（对 occupancy 约束不变）。

## 3. SMEM 占用重算（按 `.cuh` 结构）

### 3.1 Union 区

- `u.q_kv.kv`: `[16, 576] bf16` = `16*576*2` = `18,432 B`
- `u.q_kv.q_nope`: `[64, 512] bf16` = `65,536 B`
- `u.q_kv.q_rope`: `[64, 64] bf16` = `8,192 B`
- `u.q_kv` 小计 = `92,160 B`（90.0 KB）

- `u.dq`: `[64, 576] bf16` = `73,728 B`（72.0 KB）

Union 取大：`92,160 B`（90.0 KB）

### 3.2 固定常驻区

- `dO`: `[64, 512] bf16` = `65,536 B`（64.0 KB）
- `sdKV`: `[32, 576] float` = `73,728 B`（72.0 KB）
- `is_k_valid[B_TOPK/8]`: `4 B`
- `19` 个 barrier（按 `8B` 估算）: `152 B`
- `tmem_start_addr`: `4 B`

固定区小计：`139,424 B`（136.2 KB）

### 3.3 总量与使用率

- 总 SMEM 估算：`92,160 + 139,424 = 231,584 B`（约 226.2 KB）
- SM100 上限：`232,448 B`（227 KB）
- 使用率：`~99.6%`
- 剩余裕量：`864 B`

## 4. 与旧版反向分析对比

| 指标 | 旧分析 | 当前 `.cuh` 口径 | 变化 |
| :--- | :---: | :---: | :---: |
| `B_TOPK` | 64 | 32 | 降低 tile 粒度 |
| TMEM 地址布局 | 贴满到 512 | 显式映射约到 500 | 复用更细化 |
| TMEM 分配 | 512 列 | 512 列 | 实际占用不变 |
| SMEM 主要压力 | `q_kv` + `dO` + `s/ds` | `q_kv` + `dO` + `sdKV(float)` | 压力从 `s/ds` 转向 `sdKV` |
| SMEM 使用率 | ~99.4% | ~99.6% | 更接近上限 |

## 5. 优化结论与优先级

### 5.1 结论

- 优化方向已从“TMEM 地址塞满”转为“SMEM 常驻区挤压”，核心热点是 `sdKV(float)`。
- `B_TOPK=32` 降低了单次计算粒度，有利于 dKV 路径重构，但并未带来明显片上资源余量。
- 当前设计是典型“以空间换异步/规约路径”的极限方案，后续增量功能风险点在 SMEM，而不是寄存器。

### 5.2 建议优先级

1. `P0`: 先实测 `sizeof(SharedMemoryPlan)` 并补齐静态断言，避免 barrier/对齐变化导致越界。
2. `P0`: 评估 `sdKV` 精度与带宽折中（例如分块/压缩/半精存储+局部升精），这是最大单块常驻内存。
3. `P1`: 若要扩展功能，优先做时间复用（阶段化重用同一 SMEM 区）而不是新增常驻数组。
4. `P1`: TMEM 若希望释放给并发 CTA，需从 `allocate(512)` 下手，而非只改列映射。

## 6. 风险与一致性说明

当前工程内存在静态定义不一致迹象（例如 `.cuh` 的 `B_TOPK=32` 与 `.cu` 中部分 `B_TOPK==64` 断言/注释并存）。本分析严格按 `mla_bwd.cuh` 静态资源布局给出，建议在统一配置后再做一次最终口径收敛。
