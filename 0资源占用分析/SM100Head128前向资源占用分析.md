# SM100 资源占用分析

基于 `FlashMLA/csrc/sm100/prefill/sparse/fwd/head128/config.h` 的代码分析以及 `SM100.md` 的硬件规格，以下是关于 FlashMLA 在 SM100 架构上 Prefill 阶段 (head dim 128) 的 Shared Memory 和 TMEM 资源占用分析。

假设配置：`D_QK = 576` (MLA 常见配置, 512+64)，`D_tQ = 384` (Tensor Core 计算维度)。

## 1. TMEM (Tensor Memory) 占用分析

SM100 的 TMEM 总容量为 256 KB，结构为 128 行 × 512 列 × 4 字节。FlashMLA 通过 `tmem_cols` 结构体对 TMEM 列进行了明确划分。

### 列分配情况
代码定义如下 (`config.h`):
```cpp
struct tmem_cols {
    //   0 ~ 256: output
    // 256 ~ 320: P
    // 320 ~ 512: Q[D_QK-D_tQ:]
    static constexpr int o = 0;
    static constexpr int p = 256;
    static constexpr int q = 512 - D_tQ/2; // 512 - 384/2 = 320
};
```

| 变量 | 描述 | 数据类型 | Shape | 起始列 | 结束列 | 占用列数 | 占用大小 (KB) | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| `o` | Output (O) | fp32 | [128, 256] | 0 | 256 | **256** | 128 | 用于累加输出结果 |
| `p` | P (Logits) | fp32 | [128, 64] | 256 | 320 | **64** | 32 | 用于存储 Attention Scores |
| `q` | Query (Q) | bf16 | [128, 384] | 320 | 512 | **192** | 96 | 用于存储 Q 的一部分 (对应 `D_tQ=384` 维) |
| **总计** | | | | | | **512** | **256** | |

*注：Q 在 TMEM 中占用 192 列。每列 4 字节，共 768 字节/行。这正好对应 384 个 bf16 元素 (384 * 2 bytes = 768 bytes)。*

### 结论
*   **TMEM 使用量**: 256 KB (512 列)
*   **TMEM 总容量**: 256 KB (512 列)
*   **使用率**: **100%**

TMEM 资源被完全分配，没有剩余空间。这是该 Kernel 的主要硬件瓶颈之一。

---

## 2. Shared Memory (共享内存) 占用分析

SM100 每 SM 可配置的最大共享内存为 227 KB。FlashMLA 使用 `SharedMemoryPlan` 结构体管理共享内存。

### 内存布局计算
`SharedMemoryPlan`包含一个主要的 `union` 和其他固定成员。

#### A. Union 部分 (取最大值)
Union 包含 `q_full`, `s`, `o` 三种主要状态。

1.  **状态 1: `q_full` (加载完整 Q)**
    *   大小: `64 * D_QK * 2 bytes` (bf16)
    *   计算: `64 * 576 * 2` = **73,728 bytes** (72 KB)

2.  **状态 2: `s` (核心计算阶段)**
    *   包含 `sq`, `v`, `k` 三部分。
    *   `sq`: `64 * (D_QK - D_tQ) * 2` = `64 * 192 * 2` = **24,576 bytes**
    *   `v`: `256 * 128 * 2` (SmemLayoutV) = **65,536 bytes**
    *   `k`: `64 * D_QK * 2` = `64 * 576 * 2` = **73,728 bytes**
    *   总计: `24,576 + 65,536 + 73,728` = **163,840 bytes** (160 KB)

3.  **状态 3: `o` (输出处理)**
    *   大小: `64 * 512 * 2` = **65,536 bytes** (64 KB)

**Union 最大占用**: **163,840 bytes** (160 KB)

#### B. 固定成员部分
除了 Union 外，还有必须始终存在的成员：

1.  `s` (SmemLayoutSTiles<2>): `64 * 128 * 2` = **16,384 bytes**
2.  `p` (float buffer): `64 * 128 * 4` = **32,768 bytes**
3.  `tmem_start_addr` & buffers: ~1 KB (**1,028 bytes**)
4.  Barriers (`transac_bar_t`): 约 26 个 barrier，每个 8 字节 ≈ **208 bytes**
5.  其他对齐开销: 忽略不计

**固定成员总计**: ≈ **50,388 bytes**

### 总占用量与使用率

| 组件 | 大小 (Bytes) | 大小 (KB) |
| :--- | :--- | :--- |
| Union (Max) | 163,840 | 160.0 |
| 固定成员 | 50,388 | 49.2 |
| **总计** | **214,228** | **209.2** |

*   **SM100 共享内存上限**: 227 KB (232,448 bytes)
*   **预估使用量**: ~209.2 KB
*   **使用率**: **~92.2%**

### 结论
共享内存使用率极高 (>90%)，接近硬件极限。结合 100% 的 TMEM 使用率，表明该 Kernel 经过了极致的内存优化，旨在充分压榨 SM100 的片上存储资源。任何进一步增加 head dim 或 tile size 的尝试都可能导致 Shared Memory 溢出或寄存器溢出（降低 Occupancy）。
